<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width">
<title>Community</title>
<style>
  body{font-family:Arial;background:linear-gradient(135deg,#fffaf0,#eef5ff);padding:24px;margin:0}
  #posts{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;max-width:1100px;margin:0 auto}
  .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.06);position:relative}
  .del{position:absolute;right:10px;top:10px;background:#ff1744;color:#fff;border:none;padding:6px;border-radius:6px;cursor:pointer}
  h3{color:#4b2b7f;margin:0 0 6px}
  p{color:#333;white-space:pre-wrap}
</style>
</head><body>
<h2 style="text-align:center;color:#5c2e91">Community Stories</h2>
<div id="posts">Loading...</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyv9is7UmQ_04vuRKqHQC-fMwGEXdZ9BXozoGD7gFjZiUhJXbj9J0E2Uec7mZaPDk5H/exec";
const SECRET_KEY = "v8YhT93NfZ2jP6mXcA7rL1kE5s";
function getFp(){ try{ return btoa(navigator.userAgent+"||"+screen.width+"x"+screen.height+"||"+Intl.DateTimeFormat().resolvedOptions().timeZone); }catch(e){return navigator.userAgent||"unk"} }
function escapeHTML(s){ return (s||"").replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
function getDeleted(){ return JSON.parse(localStorage.getItem('deletedPosts') || "[]"); }
function saveDeleted(arr){ localStorage.setItem('deletedPosts', JSON.stringify(arr)); }

async function loadPosts(){
  const container = document.getElementById('posts');
  container.innerHTML = "Loading...";
  const url = SCRIPT_URL + "?action=getPosts&key=" + encodeURIComponent(SECRET_KEY) + "&ref=" + encodeURIComponent(window.location.origin) + "&fp=" + encodeURIComponent(getFp());
  try{
    const r = await fetch(url);
    const txt = await r.text();
    let posts = [];
    try{ posts = JSON.parse(txt); }catch(e){ container.innerText = "Error loading posts"; return; }
    const deleted = getDeleted();
    if(!Array.isArray(posts) || posts.length===0){ container.innerHTML = "<div style='text-align:center;color:#666'>No posts yet.</div>"; return; }
    container.innerHTML = "";
    posts.forEach(p=>{
      if(deleted.includes(p.title)) return;
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = "<h3>"+escapeHTML(p.title)+"</h3><small>by "+escapeHTML(p.name)+"</small><p>"+escapeHTML(p.content)+"</p>";
      const btn = document.createElement('button'); btn.className='del'; btn.textContent='Delete';
      btn.onclick = ()=>{ card.remove(); const arr=getDeleted(); if(!arr.includes(p.title)) arr.push(p.title); saveDeleted(arr); };
      card.appendChild(btn); container.appendChild(card);
    });
  }catch(err){
    container.innerText = "Network error";
  }
}
loadPosts();
</script>
</body></html>
