<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Stories ‚Äì Newsletter</title>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg,#fffaf0,#eef5ff);
    margin: 0; padding: 20px;
  }
  h1 { text-align:center; color:#5c2e91; }
  .container { max-width:800px; margin:20px auto; }
  textarea, input { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ccc; font-size:15px; }
  button { padding:10px 20px; border:none; border-radius:8px; background:#1976d2; color:white; cursor:pointer; font-size:15px; transition:0.3s; }
  button:hover { background:#0d47a1; }
  #posts { display:grid; grid-template-columns:1fr; gap:16px; margin-top:20px; }
  .post { background:white; padding:14px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.06); }
  .post h3 { margin:0 0 6px; color:#4b2b7f; }
  .post p { margin:0 0 6px; white-space:pre-wrap; color:#333; }
  .post small { color:#555; }
  .popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:999; }
  .popup-content { background:white; padding:25px 35px; border-radius:12px; text-align:center; }
</style>
</head>
<body>

<h1>üì∞ Community Stories</h1>
<div class="container">
  <h2>Share Your Story</h2>
  <input type="text" id="name" placeholder="Your name (optional)">
  <input type="text" id="email" placeholder="Your email (optional)">
  <input type="text" id="title" placeholder="Story Title">
  <textarea id="content" rows="5" placeholder="Write your story here..."></textarea>
  <button onclick="submitStory()">Post Story</button>

  <h2>All Stories</h2>
  <div id="posts">Loading posts...</div>
</div>

<!-- Popup -->
<div class="popup" id="popup">
  <div class="popup-content">
    <h3 id="popupTitle">Please wait...</h3>
    <p id="popupMsg">Processing...</p>
    <button id="closePopup" style="display:none;" onclick="closePopupFunc()">OK</button>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVkfjiTn8IeYxNYw0gcHjZfe_mEfr-Sic-Km3S8RR1D3G2ILeC-2Dnrw_kngJ40tJm/exec";
const SECRET_KEY = "v8YhT93NfZ2jP6mXcA7rL1kE5s";

const popup = document.getElementById("popup");
const popupTitle = document.getElementById("popupTitle");
const popupMsg = document.getElementById("popupMsg");
const closePopup = document.getElementById("closePopup");

function showPopup(title, msg, autoClose=false) {
  popupTitle.textContent = title;
  popupMsg.textContent = msg;
  popup.style.display = "flex";
  closePopup.style.display = autoClose ? "none" : "inline-block";
}

function closePopupFunc() {
  popup.style.display = "none";
}

async function loadPosts() {
  const container = document.getElementById("posts");
  container.innerHTML = "<p>Loading posts...</p>";

  try {
    const response = await fetch(`${SCRIPT_URL}?action=getPosts&key=${SECRET_KEY}&origin=${window.location.origin}`);
    const text = await response.text();
    let posts = [];
    try { posts = JSON.parse(text); } catch(e){ console.error(e); }

    if(!posts || posts.length === 0){
      container.innerHTML = "<p>No stories yet. Be the first to share!</p>";
      return;
    }

    container.innerHTML = "";
    posts.reverse().forEach(post=>{
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `<h3>${post.title}</h3><p>${post.content}</p><small>‚úçÔ∏è ${post.name} ‚Ä¢ ${new Date(post.timestamp).toLocaleString()}</small>`;
      container.appendChild(div);
    });
  } catch(e){
    console.error(e);
    container.innerHTML = "<p>Failed to load posts. Please try later.</p>";
  }
}

async function submitStory(){
  const name = document.getElementById("name").value.trim() || "Anonymous";
  const email = document.getElementById("email").value.trim() || "unknown@example.com";
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();

  if(!title || !content){
    showPopup("‚ö†Ô∏è Missing Info","Please provide a title and content");
    return;
  }

  const formData = new URLSearchParams();
  formData.append("action","submitStory");
  formData.append("name",name);
  formData.append("email",email);
  formData.append("title",title);
  formData.append("content",content);
  formData.append("key",SECRET_KEY);
  formData.append("origin",window.location.origin);

  showPopup("‚è≥ Posting...","Please wait");

  try {
    const res = await fetch(SCRIPT_URL,{method:"POST",body:formData});
    const text = await res.text();
    showPopup("‚úÖ Success", text, true);
    setTimeout(()=>{ closePopupFunc(); loadPosts(); },1500);
  } catch(err){
    console.error(err);
    showPopup("‚ö†Ô∏è Error","Failed to post story. Try again later.");
  }
}

// Load posts on page load
document.addEventListener("DOMContentLoaded", loadPosts);
</script>

</body>
</html>
