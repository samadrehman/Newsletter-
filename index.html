<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Stories üåü</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">

 <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-STRPMP0TZQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-STRPMP0TZQ');
  </script>
</head>
<body>

<header>
  <h1>üåç Community Stories</h1>
  <p>Share your voice. Inspire the world.</p>
</header>

<button class="btn" id="developer"><a href="about.html">‚úçÔ∏è about developer</a></button>

<input type="text" id="searchInput" placeholder="üîç Search stories...">

<div id="posts">Loading posts...</div>

<button class="floating-btn" id="toggleForm">‚úçÔ∏è Post Your Story</button>

<form id="storyForm">
  <input type="text" id="title" placeholder="Story title" required>
  <textarea id="content" rows="4" placeholder="Write your story..." required></textarea>
  <button type="submit">Publish üöÄ</button>
</form>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzidfGQ9i7zJ1yR0Vc57z6QGHGIj8xQGjSUDlup6RcscKpn69FBZP4h_kvm1zmuI_X9/exec"; // replace with your deployed Google Apps Script URL

const postsContainer = document.getElementById("posts");
const searchInput = document.getElementById("searchInput");

// Load posts
async function loadPosts() {
  postsContainer.innerHTML = "Loading posts...";
  try {
    const res = await fetch(SCRIPT_URL + "?action=getPosts");
    const data = await res.json();
    displayPosts(data.reverse());
  } catch (err) {
    console.error(err);
    postsContainer.innerHTML = "Failed to load posts.";
  }
}

function displayPosts(posts) {
  const filter = searchInput.value.toLowerCase();
  postsContainer.innerHTML = "";

  posts.filter(p => p.title.toLowerCase().includes(filter) || p.content.toLowerCase().includes(filter))
       .forEach(p => {
    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `
      <h3>${p.title}</h3>
      <p>${p.content}</p>
      <div style="margin-top:10px;">
        <small>${new Date(p.timestamp).toLocaleString()}</small>
        <button class="like-btn" data-id="${p.id}">‚ù§Ô∏è ${p.likes || 0}</button>
      </div>
    `;
    postsContainer.appendChild(div);
  });

  document.querySelectorAll(".like-btn").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;
      try {
        const res = await fetch(SCRIPT_URL, {
          method:"POST",
          body: new URLSearchParams({action:"likePost", id})
        });
        const data = await res.json();
        if(data.status==="success") btn.innerText = `‚ù§Ô∏è ${data.likes}`;
      } catch(err) {console.error(err);}
    };
  });
}

searchInput.addEventListener("input", loadPosts);

// Toggle post form
document.getElementById("toggleForm").onclick = () => {
  const form = document.getElementById("storyForm");
  form.style.display = form.style.display==="block"?"none":"block";
};

document.getElementById("storyForm").onsubmit = async (e) => {
  e.preventDefault();
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();
  try {
    await fetch(SCRIPT_URL, {
      method:"POST",
      body: new URLSearchParams({action:"addPost", title, content})
    });
    document.getElementById("storyForm").reset();
    document.getElementById("storyForm").style.display="none";
    loadPosts();
  } catch(err) {
    alert("Error posting story."); console.error(err);
  }
};

loadPosts();
</script>

</body>
</html>
